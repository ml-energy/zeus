
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Deep learning energy measurement and optimization">
      
      
        <meta name="author" content="Zeus team">
      
      
        <link rel="canonical" href="https://ml.energy/zeus/reference/_legacy/simulate/">
      
      
        <link rel="prev" href="../policy/optimizer/">
      
      
        <link rel="next" href="../../callback/">
      
      
      <link rel="icon" href="../../../assets/img/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.19">
    
    
      
        <title>simulate - Zeus Project</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/css/custom.css">
    
      <link rel="stylesheet" href="../../../assets/css/color.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-T3W21TQ7FJ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-T3W21TQ7FJ",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-T3W21TQ7FJ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="simulate - Zeus Project" >
      
        <meta  property="og:description"  content="Deep learning energy measurement and optimization" >
      
        <meta  property="og:image"  content="https://ml.energy/zeus/assets/img/social/reference/_legacy/simulate.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://ml.energy/zeus/reference/_legacy/simulate/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="simulate - Zeus Project" >
      
        <meta  name="twitter:description"  content="Deep learning energy measurement and optimization" >
      
        <meta  name="twitter:image"  content="https://ml.energy/zeus/assets/img/social/reference/_legacy/simulate.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="zeus" data-md-color-accent="zeus">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zeus._legacy.simulate" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="Don't show this again">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
              </button>
            
            
We're sharing updates via <a href="https://buttondown.com/ml-energy">The ML.ENERGY Newsletter</a>!
&middot;
Join the Zeus
<span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 15a2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2h2v2m1 0a2 2 0 0 1 2-2 2 2 0 0 1 2 2v5a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-5m2-8a2 2 0 0 1-2-2 2 2 0 0 1 2-2 2 2 0 0 1 2 2v2H9m0 1a2 2 0 0 1 2 2 2 2 0 0 1-2 2H4a2 2 0 0 1-2-2 2 2 0 0 1 2-2h5m8 2a2 2 0 0 1 2-2 2 2 0 0 1 2 2 2 2 0 0 1-2 2h-2v-2m-1 0a2 2 0 0 1-2 2 2 2 0 0 1-2-2V5a2 2 0 0 1 2-2 2 2 0 0 1 2 2v5m-2 8a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2v-2h2m0-1a2 2 0 0 1-2-2 2 2 0 0 1 2-2h5a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-5Z"></path></svg></span>
<a href="https://join.slack.com/t/zeus-ml/shared_invite/zt-36fl1m7qa-Ihky6FbfxLtobx40hMj3VA">Slack workspace</a>
to reach out to us.

          </div>
          
            <script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Zeus Project" class="md-header__button md-logo" aria-label="Zeus Project" data-md-component="logo">
      
  <img src="../../../assets/img/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Zeus Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              simulate
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="zeus" data-md-color-accent="zeus"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ml-energy/zeus" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ml-energy/zeus
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Zeus

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../getting_started/" class="md-tabs__link">
        
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../measure/" class="md-tabs__link">
        
  
    
  
  Measuring Energy

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../optimize/" class="md-tabs__link">
        
  
    
  
  Optimizing Energy

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../research_overview/" class="md-tabs__link">
        
  
    
  
  Research Overview

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  Source Code Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Zeus Project" class="md-nav__button md-logo" aria-label="Zeus Project" data-md-component="logo">
      
  <img src="../../../assets/img/logo.svg" alt="logo">

    </a>
    Zeus Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ml-energy/zeus" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    ml-energy/zeus
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zeus
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../measure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Measuring Energy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../optimize/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Optimizing Energy
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Optimizing Energy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../optimize/power_limit_optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Power Limit Optimizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../optimize/batch_size_optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Batch Size Optimizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../optimize/pipeline_frequency_optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pipeline Frequency Optimizer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../research_overview/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Research Overview
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Research Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../research_overview/zeus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zeus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../research_overview/perseus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Perseus
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Source Code Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Source Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Source Code Reference
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            Source Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    _legacy
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_1" id="__nav_6_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_1_1">
            <span class="md-nav__icon md-icon"></span>
            _legacy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../job/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    job
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_1_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../policy/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    policy
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_1_2" id="__nav_6_1_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_1_2">
            <span class="md-nav__icon md-icon"></span>
            policy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../policy/interface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    interface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../policy/mab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../policy/optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optimizer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    simulate
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    simulate
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#zeus._legacy.simulate" class="md-nav__link">
    <span class="md-ellipsis">
      simulate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="simulate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.HistoryEntry" class="md-nav__link">
    <span class="md-ellipsis">
      HistoryEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator" class="md-nav__link">
    <span class="md-ellipsis">
      Simulator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator.simulate_one_job" class="md-nav__link">
    <span class="md-ellipsis">
      simulate_one_job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator.simulate_one_alibaba_group" class="md-nav__link">
    <span class="md-ellipsis">
      simulate_one_alibaba_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator._run_job" class="md-nav__link">
    <span class="md-ellipsis">
      _run_job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator._profile_power_limit" class="md-nav__link">
    <span class="md-ellipsis">
      _profile_power_limit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator._profile_batch_size_range" class="md-nav__link">
    <span class="md-ellipsis">
      _profile_batch_size_range
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callback/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    callback
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../device/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    device
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_3" id="__nav_6_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3">
            <span class="md-nav__icon md-icon"></span>
            device
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../device/cpu/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    cpu
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_3_2" id="__nav_6_1_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3_2">
            <span class="md-nav__icon md-icon"></span>
            cpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/cpu/common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/cpu/rapl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rapl
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/exception/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exception
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../device/gpu/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    gpu
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_3_4" id="__nav_6_1_3_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3_4">
            <span class="md-nav__icon md-icon"></span>
            gpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/gpu/amd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    amd
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/gpu/common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/gpu/nvidia/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nvidia
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../device/soc/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    soc
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_3_5" id="__nav_6_1_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_3_5">
            <span class="md-nav__icon md-icon"></span>
            soc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/soc/apple/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    apple
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/soc/common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../device/soc/jetson/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jetson
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../exception/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exception
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    metric
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../monitor/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    monitor
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_6" id="__nav_6_1_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_6">
            <span class="md-nav__icon md-icon"></span>
            monitor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/carbon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    carbon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/energy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    energy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/power/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    power
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/power_streaming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    power_streaming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/price/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    price
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../monitor/temperature/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    temperature
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    optimizer
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7" id="__nav_6_1_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7">
            <span class="md-nav__icon md-icon"></span>
            optimizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/batch_size/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    batch_size
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_1" id="__nav_6_1_7_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_1">
            <span class="md-nav__icon md-icon"></span>
            batch_size
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_1_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/batch_size/server/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    server
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_1_4" id="__nav_6_1_7_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_1_7_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_1_4">
            <span class="md-nav__icon md-icon"></span>
            server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_1_4_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/batch_size/server/batch_size_state/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    batch_size_state
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_1_4_1" id="__nav_6_1_7_1_4_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_6_1_7_1_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_1_4_1">
            <span class="md-nav__icon md-icon"></span>
            batch_size_state
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/batch_size_state/commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/batch_size_state/models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/batch_size_state/repository/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repository
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_1_4_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/batch_size/server/database/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    database
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_1_4_3" id="__nav_6_1_7_1_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_6_1_7_1_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_1_4_3">
            <span class="md-nav__icon md-icon"></span>
            database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/database/db_connection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    db_connection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/database/repository/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repository
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/database/schema/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    schema
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/explorer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    explorer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_1_4_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/batch_size/server/job/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    job
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_1_4_6" id="__nav_6_1_7_1_4_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_6_1_7_1_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_1_4_6">
            <span class="md-nav__icon md-icon"></span>
            job
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/job/commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/job/models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/job/repository/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    repository
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/mab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optimizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/router/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    router
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_1_4_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/batch_size/server/services/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    services
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_1_4_10" id="__nav_6_1_7_1_4_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="6" aria-labelledby="__nav_6_1_7_1_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_1_4_10">
            <span class="md-nav__icon md-icon"></span>
            services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/services/commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/batch_size/server/services/service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    service
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/pipeline_frequency/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    pipeline_frequency
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_2" id="__nav_6_1_7_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_6_1_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_2">
            <span class="md-nav__icon md-icon"></span>
            pipeline_frequency
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/pipeline_frequency/common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/pipeline_frequency/frequency_controller/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    frequency_controller
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/pipeline_frequency/optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optimizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_7_2_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../optimizer/pipeline_frequency/server/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    server
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_7_2_4" id="__nav_6_1_7_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_6_1_7_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_7_2_4">
            <span class="md-nav__icon md-icon"></span>
            server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/pipeline_frequency/server/job_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    job_manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/pipeline_frequency/server/router/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    router
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/pipeline_frequency/server/scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scheduler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../optimizer/power_limit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    power_limit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../show_env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    show_env
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../utils/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    utils
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6_1_9" id="__nav_6_1_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1_9">
            <span class="md-nav__icon md-icon"></span>
            utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/async_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    async_utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/env/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    env
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/framework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    framework
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/lat_lon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lat_lon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/lr_scaler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lr_scaler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    metric
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/multiprocessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    multiprocessing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/pydantic_v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pydantic_v1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/zeusd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zeusd
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#zeus._legacy.simulate" class="md-nav__link">
    <span class="md-ellipsis">
      simulate
    </span>
  </a>
  
    <nav class="md-nav" aria-label="simulate">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.HistoryEntry" class="md-nav__link">
    <span class="md-ellipsis">
      HistoryEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator" class="md-nav__link">
    <span class="md-ellipsis">
      Simulator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator.simulate_one_job" class="md-nav__link">
    <span class="md-ellipsis">
      simulate_one_job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator.simulate_one_alibaba_group" class="md-nav__link">
    <span class="md-ellipsis">
      simulate_one_alibaba_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator._run_job" class="md-nav__link">
    <span class="md-ellipsis">
      _run_job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator._profile_power_limit" class="md-nav__link">
    <span class="md-ellipsis">
      _profile_power_limit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zeus._legacy.simulate.Simulator._profile_batch_size_range" class="md-nav__link">
    <span class="md-ellipsis">
      _profile_batch_size_range
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>simulate</h1>

<div class="doc doc-object doc-module">



<h2 id="zeus._legacy.simulate" class="doc doc-heading">
            <span class="doc doc-object-name doc-module-name">zeus._legacy.simulate</span>


</h2>

    <div class="doc doc-contents first">

        <p>A simulator for running trace-driven Zeus experiments.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="zeus._legacy.simulate.HistoryEntry" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">HistoryEntry</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">


        <p>Represents the config and result of a job run that may have failed.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="zeus._legacy.simulate.HistoryEntry.bs">bs</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zeus._legacy.simulate.HistoryEntry.pl">pl</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Power limit</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zeus._legacy.simulate.HistoryEntry.energy">energy</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Energy consumption in Joules</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zeus._legacy.simulate.HistoryEntry.reached">reached</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the target metric was reached at the end</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zeus._legacy.simulate.HistoryEntry.time">time</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time consumption in seconds</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HistoryEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the config and result of a job run that may have failed.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        bs: Batch size</span>
<span class="sd">        pl: Power limit</span>
<span class="sd">        energy: Energy consumption in Joules</span>
<span class="sd">        reached: Whether the target metric was reached at the end</span>
<span class="sd">        time: Time consumption in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bs</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pl</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">reached</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="zeus._legacy.simulate.Simulator" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">Simulator</span>


</h3>


    <div class="doc doc-contents ">


        <p>Simulates job execution optimized by Zeus.</p>








              <details class="quote">
                <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates job execution optimized by Zeus.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">summary_train</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">summary_power</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">batch_size_optimizer</span><span class="p">:</span> <span class="n">BatchSizeOptimizer</span><span class="p">,</span>
        <span class="n">power_limit_optimizer</span><span class="p">:</span> <span class="n">PowerLimitOptimizer</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123456</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the simulator.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_train: Path to or `pd.DataFrame` of the train trace.</span>
<span class="sd">            summary_power: Path to or `pd.DataFrame` of the power trace.</span>
<span class="sd">            batch_size_optimizer: The user is expected to construct</span>
<span class="sd">                the BSO with the desired policy and pass it into the simulator.</span>
<span class="sd">            power_limit_optimizer: The user is expected to construct</span>
<span class="sd">                the PLO with the desired policy and pass it into the simulator.</span>
<span class="sd">            seed: The random seed. Every invocation of any simulation method in this</span>
<span class="sd">                class is deterministic given the random seed, because the internal RNG is</span>
<span class="sd">                deepcopied before running the simulation.</span>
<span class="sd">            verbose: Whether to log out the internal states of the simulator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate relevant data.</span>
        <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">summary_train</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summary_train</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">summary_train</span>
        <span class="n">power_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">summary_power</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summary_power</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">summary_power</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">power_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;TTA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">target_epoch</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">time_per_epoch</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ETA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">TTA</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">average_power</span>
        <span class="c1"># &#39;energy_per_epoch&#39; is used to compare different power limits with the same batch size</span>
        <span class="c1"># when trying to figure out which power limit is the best one.</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;energy_per_epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time_per_epoch</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">average_power</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># Knob optimizers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bso</span> <span class="o">=</span> <span class="n">batch_size_optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plo</span> <span class="o">=</span> <span class="n">power_limit_optimizer</span>

        <span class="c1"># Save arguments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_one_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
        <span class="n">num_recurrence</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">beta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Simulate a sequentially recurring job. Explore with early stopping.</span>

<span class="sd">        Args:</span>
<span class="sd">            job: Job spec to simulate.</span>
<span class="sd">            num_recurrence: How many times the job recurs.</span>
<span class="sd">            beta_knob: `beta_knob * min_eta` is the early stopping cost threshold.</span>
<span class="sd">                Set to `np.inf` to disable early stopping.</span>
<span class="sd">            eta_knob: $\eta$ used in the hybrid cost metric.</span>
<span class="sd">                $\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}$</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of [`HistoryEntry`][zeus._legacy.simulate.HistoryEntry] objects for each job run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy all internal state so that simulation does not modify any</span>
        <span class="c1"># internal state and is deterministic w.r.t. the random seed.</span>
        <span class="n">bso</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bso</span><span class="p">)</span>
        <span class="n">plo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plo</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># Figure out MAXPOWER.</span>
        <span class="n">max_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Max power = </span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>

        <span class="c1"># Track the minimum cost observed for the early stopping energy threshold.</span>
        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># Simulate each job one at a time.</span>
        <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> recurring </span><span class="si">{</span><span class="n">num_recurrence</span><span class="si">}</span><span class="s2"> times.&quot;</span><span class="p">)</span>

        <span class="c1"># A new job. Profile the feasible batch size range.</span>
        <span class="n">batch_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_batch_size_range</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="c1"># Register the job in the BSO.</span>
        <span class="n">bso</span><span class="o">.</span><span class="n">register_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">batch_sizes</span><span class="p">)</span>

        <span class="c1"># Job recurs.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_recurrence</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recurrence: </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Run the job until convergence. Upper bound the number of retries to 20.</span>
            <span class="c1"># Accumulate the cost of retries before convergence.</span>
            <span class="n">cost_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">tries</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
                <span class="c1"># Whether this run of the job needed to profile power.</span>
                <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Fetch knobs to use.</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

                <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
                <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                    <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">pl</span>

                <span class="c1"># Run the job, potentially early stopping it.</span>
                <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                    <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                    <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                    <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                    <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                    <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># The job never ran because even one epoch exceeds the cost threshold.</span>
                <span class="c1"># Let the BSO observe that this batch size is bad, but since the job</span>
                <span class="c1"># did not run, do not add to the history and retry.</span>
                <span class="k">if</span> <span class="n">eta</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tta</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reached</span><span class="p">:</span>
                    <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Compute the hybrid cost metric.</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>
                <span class="n">cost_acc</span> <span class="o">+=</span> <span class="n">cost</span>

                <span class="c1"># Provide feedback to the BSO.</span>
                <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">reached</span><span class="p">)</span>

                <span class="c1"># Record history for analysis.</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HistoryEntry</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">reached</span><span class="p">,</span> <span class="n">tta</span><span class="p">))</span>

                <span class="c1"># Reached the target metric. Update min_cost and go on to the next recurrence.</span>
                <span class="k">if</span> <span class="n">reached</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Reached target metric in </span><span class="si">{</span><span class="n">tries</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;try&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">tries</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;tries&#39;</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">min_cost</span> <span class="o">&gt;</span> <span class="n">cost_acc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Minimum cost updated from </span><span class="si">{</span><span class="n">min_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">cost_acc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">cost_acc</span>
                    <span class="k">break</span>
                <span class="c1"># Didn&#39;t reach the target metric.</span>
                <span class="c1"># We assume that the default BS (set by the user) will always converge.</span>
                <span class="c1"># That is, reaching the target metric with the model should be a feasible task.</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The default batch size </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">default_bs</span><span class="si">}</span><span class="s2"> did not converge.&quot;</span><span class="p">)</span>

            <span class="c1"># Target metric was not reached in 20 tries. We consider this target metric to be unreachable.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Job did not reach the target metric in 20 tries.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> (BS, PL, ETA, whether_reached, TTA) history: </span><span class="se">\n</span><span class="si">{</span><span class="n">history</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">history</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_one_alibaba_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
        <span class="n">group_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">beta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run simulation on one group in the Alibaba trace.</span>

<span class="sd">        Concurrent job submissions (jobs that start before the previous job</span>
<span class="sd">        finishes) are launched with the batch size known to be of minimum</span>
<span class="sd">        cost at that time. The BSO also observes the results of these jobs</span>
<span class="sd">        when they are done, and these jobs may well finish before a job that</span>
<span class="sd">        started before it. See `observe` in PruningGTSBatchSizeOptimizer for</span>
<span class="sd">        an example of handing such a scenario.</span>

<span class="sd">        Args:</span>
<span class="sd">            job: Job spec of this group.</span>
<span class="sd">            group_df: DataFrame of this group. Fields:</span>
<span class="sd">                - group: Group ID in trace. Identical across all rows.</span>
<span class="sd">                - dataset: Dataset name. Identical across all rows.</span>
<span class="sd">                - start_time: Job start time in the trace.</span>
<span class="sd">                - end_time: Job end time in the trace.</span>
<span class="sd">                - runtime_ratio: runtime of this job over the mean runtime</span>
<span class="sd">                    of all the jobs of this dataset. Captures intra-dataset</span>
<span class="sd">                    job runtime differences.</span>
<span class="sd">            beta_knob: `beta_knob * min_eta` is the early stopping cost threshold.</span>
<span class="sd">                Set to `np.inf` to disable early stopping.</span>
<span class="sd">            eta_knob: $\eta$ used in the hybrid cost metric.</span>
<span class="sd">                $\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}$</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of [`HistoryEntry`][zeus._legacy.simulate.HistoryEntry] objects for each job run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy all internal state so that simulation does not modify any</span>
        <span class="c1"># internal state and is deterministic w.r.t. the random seed.</span>
        <span class="n">bso</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bso</span><span class="p">)</span>
        <span class="n">plo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plo</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># Sanity check</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">default_bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must give the job a default batch size.&quot;</span><span class="p">)</span>

        <span class="c1"># Figure out MAXPOWER.</span>
        <span class="n">max_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Max power = </span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>

        <span class="c1"># Track the minimum cost observed for the early stopping energy threshold.</span>
        <span class="c1"># Also track the corresponding minimum cost BS to handle concurrent jobs.</span>
        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">best_bs</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">default_bs</span>

        <span class="c1"># Simulate each job one at a time.</span>
        <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> recurring </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> times.&quot;</span><span class="p">)</span>

        <span class="c1"># A new job. Profile the feasible batch size range.</span>
        <span class="n">batch_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_batch_size_range</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="c1"># Register the job in the BSO.</span>
        <span class="n">bso</span><span class="o">.</span><span class="n">register_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">batch_sizes</span><span class="p">)</span>

        <span class="c1"># List of jobs in flight.</span>
        <span class="nd">@dataclass</span>
        <span class="k">class</span><span class="w"> </span><span class="nc">RunningJob</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Represents a job that is running.</span>

<span class="sd">            We know what&#39;s going to happen to this job when we launch it.</span>
<span class="sd">            Thus, pre-compute all results (using self.run_job) and have this</span>
<span class="sd">            instance hold the information. Then, jobs will be removed from the</span>
<span class="sd">            list of running jobs when the current time passes self.end_time and</span>
<span class="sd">            the result will be observed.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span>
            <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span>
            <span class="n">runtime_ratio</span><span class="p">:</span> <span class="nb">float</span>
            <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">power_limit</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">reached</span><span class="p">:</span> <span class="nb">bool</span>
            <span class="n">time</span><span class="p">:</span> <span class="nb">float</span>
            <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>
            <span class="n">cost</span><span class="p">:</span> <span class="nb">float</span>

        <span class="n">running_jobs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RunningJob</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Jobs in group_df are already sorted by start_time.</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">rec_i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">job_row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recurrence: </span><span class="si">{</span><span class="n">rec_i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update the current time.</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">job_row</span><span class="o">.</span><span class="n">start_time</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Current time is </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Scan the in-flight job list to reap jobs that have finished.</span>
            <span class="c1"># We need a while loop here because we might have submitted a retry job</span>
            <span class="c1"># while reaping jobs that failed to reach the target metric, and that retry job</span>
            <span class="c1"># may finish before the current job.</span>
            <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&lt;=</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">running_jobs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Running jobs: </span><span class="si">{</span><span class="n">running_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># We copy running_jobs because we want to mutate it as we traverse it.</span>
                <span class="n">running_jobs_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_jobs</span><span class="p">)</span>

                <span class="c1"># Sort the jobs in the order they end.</span>
                <span class="k">for</span> <span class="n">rjob</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">running_jobs_copy</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">)):</span>
                    <span class="c1"># We&#39;re only interested in jobs that finished at this point in time.</span>
                    <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">current_time</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Job is finished at this point in time.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[Simulator] Job(BS=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,time=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">,&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;energy=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">energy</span><span class="si">}</span><span class="s2">,reached=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="si">}</span><span class="s2">) finished&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># Remove the job from the in-flight job list.</span>
                    <span class="n">running_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rjob</span><span class="p">)</span>

                    <span class="c1"># Let the BSO observe the cost for this batch size.</span>
                    <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">)</span>

                    <span class="c1"># If the job never ran because even one epoch exceeds the cost threshold,</span>
                    <span class="c1"># do not add to the history and retry.</span>
                    <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                        <span class="c1"># Record history for analysis.</span>
                        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">HistoryEntry</span><span class="p">(</span>
                                <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                                <span class="n">rjob</span><span class="o">.</span><span class="n">power_limit</span><span class="p">,</span>
                                <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the energy of this job by the runtime ratio.</span>
                                <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">,</span>
                                <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the runtime of this job by the runtime ratio.</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Reached target metric (no need to retry)</span>
                    <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">min_cost</span> <span class="o">&gt;</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Minimum cost updated from </span><span class="si">{</span><span class="n">min_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">min_cost</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span>
                            <span class="n">best_bs</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span>

                    <span class="c1"># Didn&#39;t reach target metric. Need to run a retry job.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># If there are jobs in-flight, we just run additional concurrent</span>
                        <span class="c1"># submissions with the best known knobs.</span>
                        <span class="k">if</span> <span class="n">running_jobs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are in-flight jobs. Use BS </span><span class="si">{</span><span class="n">best_bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                            <span class="n">bs</span> <span class="o">=</span> <span class="n">best_bs</span>
                            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                            <span class="k">assert</span> <span class="n">pl</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Power not profiled for best known BS </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="c1"># There are no jobs in-flight. Just submit the job normally.</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Determine the knobs.</span>
                            <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are no in-flight jobs. Use BSO&#39;s prediction </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                            <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
                            <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                                <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                                <span class="k">assert</span> <span class="n">pl</span>

                        <span class="c1"># Pre-compute the result of the job.</span>
                        <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                            <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                            <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                            <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                            <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="c1"># Compute the hybrid cost metric.</span>
                        <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>

                        <span class="c1"># Create the RunningJob instance.</span>
                        <span class="n">running_job</span> <span class="o">=</span> <span class="n">RunningJob</span><span class="p">(</span>
                            <span class="n">start_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                            <span class="n">end_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">rjob</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>  <span class="c1"># Assume same runtime.</span>
                            <span class="n">runtime_ratio</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>
                            <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                            <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                            <span class="n">reached</span><span class="o">=</span><span class="n">reached</span><span class="p">,</span>
                            <span class="n">time</span><span class="o">=</span><span class="n">tta</span><span class="p">,</span>
                            <span class="n">energy</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
                            <span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_job</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Started retry job </span><span class="si">{</span><span class="n">running_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># We must break from the loop that scans the running_jobs list, because</span>
                        <span class="c1"># the job we just submitted might actually be the next job that finishes.</span>
                        <span class="k">break</span>

            <span class="c1"># We&#39;re (finally) done reaping all finished jobs. Run the current job.</span>
            <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># If there are jobs in-flight, we just run additional concurrent</span>
            <span class="c1"># submissions with the best known knobs.</span>
            <span class="k">if</span> <span class="n">running_jobs</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are in-flight jobs. Use BS </span><span class="si">{</span><span class="n">best_bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="n">best_bs</span>
                <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">pl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Power not profiled for best known BS </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># There are no jobs in-flight. Just submit the job.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Determine the knobs.</span>
                <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are no in-flight jobs. Use BSO&#39;s prediction </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
                <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                    <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">pl</span>

            <span class="c1"># Run the job, potentially early stopping it.</span>
            <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Compute the hybrid cost metric.</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>

            <span class="c1"># Create the RunningJob instance and enqueue.</span>
            <span class="n">running_job</span> <span class="o">=</span> <span class="n">RunningJob</span><span class="p">(</span>
                <span class="n">start_time</span><span class="o">=</span><span class="n">job_row</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                <span class="n">end_time</span><span class="o">=</span><span class="n">job_row</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                <span class="n">runtime_ratio</span><span class="o">=</span><span class="n">job_row</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                <span class="n">reached</span><span class="o">=</span><span class="n">reached</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">tta</span><span class="p">,</span>
                <span class="n">energy</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
                <span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_job</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Started job </span><span class="si">{</span><span class="n">running_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Now, we&#39;re done iterating the rows of group_df.</span>
        <span class="c1"># Set the current time to infinity so that all running jobs finish.</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Simulator] Reap all jobs&quot;</span><span class="p">)</span>

        <span class="c1"># Scan the remaining in-flight job list to reap jobs that have finished.</span>
        <span class="c1"># Since current_time is infinity, this while loop will reap all the jobs ever launched.</span>
        <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&lt;=</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">running_jobs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Running jobs: </span><span class="si">{</span><span class="n">running_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># We copy running_jobs because we want to mutate it as we traverse it.</span>
            <span class="n">running_jobs_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_jobs</span><span class="p">)</span>

            <span class="c1"># Sort the jobs in the order they end.</span>
            <span class="k">for</span> <span class="n">rjob</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">running_jobs_copy</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">)):</span>
                <span class="c1"># We&#39;re only interested in jobs that finished at this point in time.</span>
                <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">current_time</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Job is finished at this point in time.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[Simulator] Job(BS=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,time=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;energy=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">energy</span><span class="si">}</span><span class="s2">,reached=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="si">}</span><span class="s2">) finished&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Remove the job from the in-flight job list.</span>
                <span class="n">running_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rjob</span><span class="p">)</span>

                <span class="c1"># Let the BSO observe the cost for this batch size.</span>
                <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">)</span>

                <span class="c1"># If the job never ran because even one epoch exceeds the cost threshold,</span>
                <span class="c1"># do not add to the history and retry.</span>
                <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                    <span class="c1"># Record history for analysis.</span>
                    <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">HistoryEntry</span><span class="p">(</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">power_limit</span><span class="p">,</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the energy of this job by the runtime ratio.</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">,</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the runtime of this job by the runtime ratio.</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Reached target metric (no need to retry)</span>
                <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">min_cost</span> <span class="o">&gt;</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Minimum cost updated from </span><span class="si">{</span><span class="n">min_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span>
                        <span class="n">best_bs</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span>

                <span class="c1"># Didin&#39;t reach target metric. Need to run a retry job.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># If there are jobs in-flight, we just run additional concurrent</span>
                    <span class="c1"># submissions with the best known knobs.</span>
                    <span class="k">if</span> <span class="n">running_jobs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are in-flight jobs. Use BS </span><span class="si">{</span><span class="n">best_bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="n">bs</span> <span class="o">=</span> <span class="n">best_bs</span>
                        <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">pl</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Power not profiled for best known BS </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="c1"># There are no jobs in-flight. Just submit the job normally.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Determine the knobs.</span>
                        <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                        <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are no in-flight jobs. Use BSO&#39;s prediction </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                        <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
                        <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                            <span class="k">assert</span> <span class="n">pl</span>

                    <span class="c1"># Pre-compute the result of the job.</span>
                    <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                        <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                        <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                        <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                        <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                        <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Compute the hybrid cost metric.</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>

                    <span class="c1"># Create the RunningJob instance.</span>
                    <span class="n">running_job</span> <span class="o">=</span> <span class="n">RunningJob</span><span class="p">(</span>
                        <span class="n">start_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                        <span class="n">end_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">rjob</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>  <span class="c1"># Assume same runtime.</span>
                        <span class="n">runtime_ratio</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                        <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                        <span class="n">reached</span><span class="o">=</span><span class="n">reached</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="n">tta</span><span class="p">,</span>
                        <span class="n">energy</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
                        <span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_job</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Started retry job </span><span class="si">{</span><span class="n">running_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># We must break from the loop that scans the running_jobs list, because</span>
                    <span class="c1"># the job we just submitted might actually be the next job that finishes.</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">history</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">power_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
        <span class="n">cost_ub</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">profile_power</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Simulate running the job and return the energy consumed and whether it converged.</span>

<span class="sd">        This method will randomly choose one of the possible training &quot;paths&quot;. Then,</span>
<span class="sd">        based on cost_ub, it will compute the maximum number of epochs the job can run.</span>
<span class="sd">        If the path&#39;s target_epoch is smaller than or equal to the maximum number of</span>
<span class="sd">        epochs, the cost incurred until target_epoch is returned. Otherwise, the cost</span>
<span class="sd">        incurred until the maximum number of epochs is returned.</span>

<span class="sd">        It is important to note that the job may never run when the first epoch&#39;s cost</span>
<span class="sd">        is already expected to exceed the cost upper bound. In such a case, the returned</span>
<span class="sd">        time and energy consumptions will be zero. This case must be treated separately</span>
<span class="sd">        in the calling code.</span>

<span class="sd">        If profile_power is True, the first epoch will JIT-profile power limits coarsely</span>
<span class="sd">        by dividing the epoch evenly into len(available_power_limits) pieces. Thus the</span>
<span class="sd">        the first epoch&#39;s energy and time consumption will be slightly adjusted.</span>

<span class="sd">        Args:</span>
<span class="sd">            job: Job spec to run.</span>
<span class="sd">            batch_size: Batch size to use.</span>
<span class="sd">            power_limit: Power limit to use. Regardless of whether this run of this</span>
<span class="sd">                batch size requires power profiling, the simulator will input the optimal</span>
<span class="sd">                power limit for the batch size. The first epoch energy consumption from</span>
<span class="sd">                power profiling is adjusted in the latter half of this method based on the</span>
<span class="sd">                profile_power flag.</span>
<span class="sd">            rng: Random number generator used to sample one training path.</span>
<span class="sd">            cost_ub: Cost upper bound. The job is terminated when the next epoch is going</span>
<span class="sd">                to exceed the cost upper bound.</span>
<span class="sd">            eta_knob: $\eta$ used in the hybrid cost metric.</span>
<span class="sd">                $\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}$</span>
<span class="sd">            profile_power: Whether this run of the job should profile power during the</span>
<span class="sd">                first epoch.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of energy consumption, time consumption, and whether the job reached the target metric.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># df is filtered with job spec, BS, and PL. We sample one possible training path.</span>
        <span class="c1"># power_df is filtered with job spec and BS. We use this to compute the energy</span>
        <span class="c1"># consumption of profiling power during the first epoch.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">filter_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">power_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">power_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">power_limit</span> <span class="o">==</span> <span class="n">power_limit</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

        <span class="c1"># Max number of epochs is bound by either the cost upper bound or the user-specified</span>
        <span class="c1"># max_epochs, whichever is smaller.</span>
        <span class="k">if</span> <span class="n">cost_ub</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="c1"># cost_ub is infinity in two cases:</span>
            <span class="c1"># 1. The simulator has never observed any cost value in the early part of simulation.</span>
            <span class="c1"># 2. We&#39;re simulating with no early stopping, i.e. beta_knob is infinity.</span>
            <span class="n">max_epochs</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">max_epochs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] Cost UB is inf. </span><span class="si">{</span><span class="n">max_epochs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Stop right before the first epoch when cost will cross the upper bound.</span>
            <span class="n">cost_per_epoch</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">eta_knob</span> <span class="o">*</span> <span class="n">path</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta_knob</span><span class="p">)</span> <span class="o">*</span> <span class="n">power_df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">path</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">max_epochs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cost_ub</span> <span class="o">//</span> <span class="n">cost_per_epoch</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">cost_ub</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">cost_per_epoch</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">max_epochs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># The job virtually never ran. Time and Energy being zero will be treated specially outside.</span>
        <span class="c1"># If the min_cost is so low, this might even prevent this BS from running at all.</span>
        <span class="k">if</span> <span class="n">max_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> cannot run even one epoch without exceeding the cost UB.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; BS </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">, PL </span><span class="si">{</span><span class="n">power_limit</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">eta_knob</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">compute_energy_and_time</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Compute the energy and time consumed for running the job for num_epochs.&quot;&quot;&quot;</span>
            <span class="c1"># This is the first run of this batch size, and we need to profile power</span>
            <span class="c1"># during the first epoch.</span>
            <span class="k">if</span> <span class="n">profile_power</span><span class="p">:</span>
                <span class="c1"># Note that power_df holds rows with all power limits. Evenly splitting the</span>
                <span class="c1"># epochs with the number of samples and running each slice with each power</span>
                <span class="c1"># limit consumes (1/N) * e_100 + (1/N) * e_125 + ... + (1/N) * e_250.</span>
                <span class="c1"># Also there are all runs 1, 2, ... included, but power info is actually</span>
                <span class="c1"># completely duplicated across different runs in the DataFrame.</span>
                <span class="c1"># Thus, taking the mean across the entire power_df gets us what we want.</span>
                <span class="n">energy_first_epoch</span> <span class="o">=</span> <span class="n">power_df</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">energy_from_second_epoch</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">energy_consumption</span> <span class="o">=</span> <span class="n">energy_first_epoch</span> <span class="o">+</span> <span class="n">energy_from_second_epoch</span>
                <span class="n">time_first_epoch</span> <span class="o">=</span> <span class="n">power_df</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">time_from_second_epoch</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">time_consumption</span> <span class="o">=</span> <span class="n">time_first_epoch</span> <span class="o">+</span> <span class="n">time_from_second_epoch</span>
            <span class="c1"># Just run num_epochs with the given power limit. Simple.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">energy_consumption</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">num_epochs</span>
                <span class="n">time_consumption</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">num_epochs</span>
            <span class="k">return</span> <span class="n">energy_consumption</span><span class="p">,</span> <span class="n">time_consumption</span>

        <span class="c1"># Job reached target metric.</span>
        <span class="n">target_epoch</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">target_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">target_epoch</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="ow">and</span> <span class="n">target_epoch</span> <span class="o">&lt;=</span> <span class="n">max_epochs</span><span class="p">:</span>
            <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span> <span class="o">=</span> <span class="n">compute_energy_and_time</span><span class="p">(</span><span class="n">target_epoch</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">power_limit</span><span class="si">}</span><span class="s2">W</span><span class="si">{</span><span class="s1">&#39; prof&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">profile_power</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;=&gt; </span><span class="se">\033</span><span class="s2">[31mReached in </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">target_epoch</span><span class="p">)</span><span class="si">}</span><span class="s2"> epochs, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;TTA </span><span class="si">{</span><span class="n">tta</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds, ETA </span><span class="si">{</span><span class="n">eta</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="kc">True</span>

        <span class="c1"># Job failed to reach the target metric.</span>
        <span class="n">energy_consumption</span><span class="p">,</span> <span class="n">time_consumption</span> <span class="o">=</span> <span class="n">compute_energy_and_time</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">power_limit</span><span class="si">}</span><span class="s2">W</span><span class="si">{</span><span class="s1">&#39; prof&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">profile_power</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;=&gt; </span><span class="se">\033</span><span class="s2">[31mFailed (stopped after </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">)</span><span class="si">}</span><span class="s2"> epochs), &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;TTA </span><span class="si">{</span><span class="n">time_consumption</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds, ETA </span><span class="si">{</span><span class="n">energy_consumption</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">energy_consumption</span><span class="p">,</span> <span class="n">time_consumption</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_profile_power_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate running the job and profiling the power limit.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping PL to `energy_per_epoch`. PL is inserted in high to low order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter by job spec and BS.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">filter_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">)]</span>

        <span class="c1"># Compute the epoch cost of each power limit (Equation 7).</span>
        <span class="n">max_pl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;power_limit&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;epoch_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta_knob</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;average_power&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta_knob</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_pl</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time_per_epoch&quot;</span><span class="p">]</span>

        <span class="c1"># We&#39;ll be profiling energy from larger to smaller power limits.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;power_limit&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">rec</span><span class="o">.</span><span class="n">power_limit</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">epoch_cost</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PL profile] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> =&gt; PL = </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">)</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_profile_batch_size_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate profiling the available batch size range of the job.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of feasible batch sizes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="c1"># Do not filter by target_metric here since we do not want to constrain</span>
        <span class="c1"># the feasible batch size range to only those that reached the target metric.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">network</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[BS profile] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> =&gt; BS = </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="zeus._legacy.simulate.Simulator.__init__" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">__init__</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span><span class="n">summary_train</span><span class="p">,</span> <span class="n">summary_power</span><span class="p">,</span> <span class="n">batch_size_optimizer</span><span class="p">,</span> <span class="n">power_limit_optimizer</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123456</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">



<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>summary_train</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to or <code>pd.DataFrame</code> of the train trace.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>summary_power</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to or <code>pd.DataFrame</code> of the power trace.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size_optimizer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;BatchSizeOptimizer&lt;/span&gt; (&lt;code&gt;zeus._legacy.policy.BatchSizeOptimizer&lt;/code&gt;)" href="../policy/interface/#zeus._legacy.policy.interface.BatchSizeOptimizer">BatchSizeOptimizer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user is expected to construct
the BSO with the desired policy and pass it into the simulator.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>power_limit_optimizer</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;PowerLimitOptimizer&lt;/span&gt; (&lt;code&gt;zeus._legacy.policy.PowerLimitOptimizer&lt;/code&gt;)" href="../policy/interface/#zeus._legacy.policy.interface.PowerLimitOptimizer">PowerLimitOptimizer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The user is expected to construct
the PLO with the desired policy and pass it into the simulator.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The random seed. Every invocation of any simulation method in this
class is deterministic given the random seed, because the internal RNG is
deepcopied before running the simulation.</p>
              </div>
            </td>
            <td>
                  <code>123456</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to log out the internal states of the simulator.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">summary_train</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">summary_power</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">batch_size_optimizer</span><span class="p">:</span> <span class="n">BatchSizeOptimizer</span><span class="p">,</span>
    <span class="n">power_limit_optimizer</span><span class="p">:</span> <span class="n">PowerLimitOptimizer</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">123456</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the simulator.</span>

<span class="sd">    Args:</span>
<span class="sd">        summary_train: Path to or `pd.DataFrame` of the train trace.</span>
<span class="sd">        summary_power: Path to or `pd.DataFrame` of the power trace.</span>
<span class="sd">        batch_size_optimizer: The user is expected to construct</span>
<span class="sd">            the BSO with the desired policy and pass it into the simulator.</span>
<span class="sd">        power_limit_optimizer: The user is expected to construct</span>
<span class="sd">            the PLO with the desired policy and pass it into the simulator.</span>
<span class="sd">        seed: The random seed. Every invocation of any simulation method in this</span>
<span class="sd">            class is deterministic given the random seed, because the internal RNG is</span>
<span class="sd">            deepcopied before running the simulation.</span>
<span class="sd">        verbose: Whether to log out the internal states of the simulator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate relevant data.</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">summary_train</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summary_train</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">summary_train</span>
    <span class="n">power_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">summary_power</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">summary_power</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">summary_power</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">power_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;TTA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">target_epoch</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">time_per_epoch</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ETA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">TTA</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">average_power</span>
    <span class="c1"># &#39;energy_per_epoch&#39; is used to compare different power limits with the same batch size</span>
    <span class="c1"># when trying to figure out which power limit is the best one.</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;energy_per_epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time_per_epoch</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">average_power</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>

    <span class="c1"># Knob optimizers.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bso</span> <span class="o">=</span> <span class="n">batch_size_optimizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plo</span> <span class="o">=</span> <span class="n">power_limit_optimizer</span>

    <span class="c1"># Save arguments.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zeus._legacy.simulate.Simulator.simulate_one_job" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">simulate_one_job</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">simulate_one_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">num_recurrence</span><span class="p">,</span> <span class="n">beta_knob</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Simulate a sequentially recurring job. Explore with early stopping.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;Job&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;zeus._legacy.job.Job&lt;/code&gt;)" href="../job/#zeus._legacy.job.Job">Job</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Job spec to simulate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_recurrence</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many times the job recurs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>beta_knob</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>beta_knob * min_eta</code> is the early stopping cost threshold.
Set to <code>np.inf</code> to disable early stopping.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eta_knob</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><span class="arithmatex">\(\eta\)</span> used in the hybrid cost metric.
<span class="arithmatex">\(\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}\)</span></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;HistoryEntry&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;zeus._legacy.simulate.HistoryEntry&lt;/code&gt;)" href="#zeus._legacy.simulate.HistoryEntry">HistoryEntry</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of <a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;HistoryEntry&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt;" href="#zeus._legacy.simulate.HistoryEntry"><code>HistoryEntry</code></a> objects for each job run.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_one_job</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">num_recurrence</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">beta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Simulate a sequentially recurring job. Explore with early stopping.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: Job spec to simulate.</span>
<span class="sd">        num_recurrence: How many times the job recurs.</span>
<span class="sd">        beta_knob: `beta_knob * min_eta` is the early stopping cost threshold.</span>
<span class="sd">            Set to `np.inf` to disable early stopping.</span>
<span class="sd">        eta_knob: $\eta$ used in the hybrid cost metric.</span>
<span class="sd">            $\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}$</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of [`HistoryEntry`][zeus._legacy.simulate.HistoryEntry] objects for each job run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy all internal state so that simulation does not modify any</span>
    <span class="c1"># internal state and is deterministic w.r.t. the random seed.</span>
    <span class="n">bso</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bso</span><span class="p">)</span>
    <span class="n">plo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plo</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Figure out MAXPOWER.</span>
    <span class="n">max_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Max power = </span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>

    <span class="c1"># Track the minimum cost observed for the early stopping energy threshold.</span>
    <span class="n">min_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># Simulate each job one at a time.</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> recurring </span><span class="si">{</span><span class="n">num_recurrence</span><span class="si">}</span><span class="s2"> times.&quot;</span><span class="p">)</span>

    <span class="c1"># A new job. Profile the feasible batch size range.</span>
    <span class="n">batch_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_batch_size_range</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="c1"># Register the job in the BSO.</span>
    <span class="n">bso</span><span class="o">.</span><span class="n">register_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">batch_sizes</span><span class="p">)</span>

    <span class="c1"># Job recurs.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_recurrence</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recurrence: </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Run the job until convergence. Upper bound the number of retries to 20.</span>
        <span class="c1"># Accumulate the cost of retries before convergence.</span>
        <span class="n">cost_acc</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">tries</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="c1"># Whether this run of the job needed to profile power.</span>
            <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Fetch knobs to use.</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

            <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
            <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">pl</span>

            <span class="c1"># Run the job, potentially early stopping it.</span>
            <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># The job never ran because even one epoch exceeds the cost threshold.</span>
            <span class="c1"># Let the BSO observe that this batch size is bad, but since the job</span>
            <span class="c1"># did not run, do not add to the history and retry.</span>
            <span class="k">if</span> <span class="n">eta</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tta</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reached</span><span class="p">:</span>
                <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Compute the hybrid cost metric.</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>
            <span class="n">cost_acc</span> <span class="o">+=</span> <span class="n">cost</span>

            <span class="c1"># Provide feedback to the BSO.</span>
            <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">reached</span><span class="p">)</span>

            <span class="c1"># Record history for analysis.</span>
            <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HistoryEntry</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">reached</span><span class="p">,</span> <span class="n">tta</span><span class="p">))</span>

            <span class="c1"># Reached the target metric. Update min_cost and go on to the next recurrence.</span>
            <span class="k">if</span> <span class="n">reached</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Reached target metric in </span><span class="si">{</span><span class="n">tries</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;try&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">tries</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;tries&#39;</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">min_cost</span> <span class="o">&gt;</span> <span class="n">cost_acc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Minimum cost updated from </span><span class="si">{</span><span class="n">min_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">cost_acc</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">min_cost</span> <span class="o">=</span> <span class="n">cost_acc</span>
                <span class="k">break</span>
            <span class="c1"># Didn&#39;t reach the target metric.</span>
            <span class="c1"># We assume that the default BS (set by the user) will always converge.</span>
            <span class="c1"># That is, reaching the target metric with the model should be a feasible task.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The default batch size </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">default_bs</span><span class="si">}</span><span class="s2"> did not converge.&quot;</span><span class="p">)</span>

        <span class="c1"># Target metric was not reached in 20 tries. We consider this target metric to be unreachable.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Job did not reach the target metric in 20 tries.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> (BS, PL, ETA, whether_reached, TTA) history: </span><span class="se">\n</span><span class="si">{</span><span class="n">history</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">history</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zeus._legacy.simulate.Simulator.simulate_one_alibaba_group" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">simulate_one_alibaba_group</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">simulate_one_alibaba_group</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">group_df</span><span class="p">,</span> <span class="n">beta_knob</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Run simulation on one group in the Alibaba trace.</p>
<p>Concurrent job submissions (jobs that start before the previous job
finishes) are launched with the batch size known to be of minimum
cost at that time. The BSO also observes the results of these jobs
when they are done, and these jobs may well finish before a job that
started before it. See <code>observe</code> in PruningGTSBatchSizeOptimizer for
an example of handing such a scenario.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;Job&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;zeus._legacy.job.Job&lt;/code&gt;)" href="../job/#zeus._legacy.job.Job">Job</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Job spec of this group.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>group_df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame of this group. Fields:
- group: Group ID in trace. Identical across all rows.
- dataset: Dataset name. Identical across all rows.
- start_time: Job start time in the trace.
- end_time: Job end time in the trace.
- runtime_ratio: runtime of this job over the mean runtime
    of all the jobs of this dataset. Captures intra-dataset
    job runtime differences.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>beta_knob</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>beta_knob * min_eta</code> is the early stopping cost threshold.
Set to <code>np.inf</code> to disable early stopping.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eta_knob</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><span class="arithmatex">\(\eta\)</span> used in the hybrid cost metric.
<span class="arithmatex">\(\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}\)</span></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;HistoryEntry&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;zeus._legacy.simulate.HistoryEntry&lt;/code&gt;)" href="#zeus._legacy.simulate.HistoryEntry">HistoryEntry</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of <a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;HistoryEntry&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt;" href="#zeus._legacy.simulate.HistoryEntry"><code>HistoryEntry</code></a> objects for each job run.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_one_alibaba_group</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">group_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">beta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run simulation on one group in the Alibaba trace.</span>

<span class="sd">    Concurrent job submissions (jobs that start before the previous job</span>
<span class="sd">    finishes) are launched with the batch size known to be of minimum</span>
<span class="sd">    cost at that time. The BSO also observes the results of these jobs</span>
<span class="sd">    when they are done, and these jobs may well finish before a job that</span>
<span class="sd">    started before it. See `observe` in PruningGTSBatchSizeOptimizer for</span>
<span class="sd">    an example of handing such a scenario.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: Job spec of this group.</span>
<span class="sd">        group_df: DataFrame of this group. Fields:</span>
<span class="sd">            - group: Group ID in trace. Identical across all rows.</span>
<span class="sd">            - dataset: Dataset name. Identical across all rows.</span>
<span class="sd">            - start_time: Job start time in the trace.</span>
<span class="sd">            - end_time: Job end time in the trace.</span>
<span class="sd">            - runtime_ratio: runtime of this job over the mean runtime</span>
<span class="sd">                of all the jobs of this dataset. Captures intra-dataset</span>
<span class="sd">                job runtime differences.</span>
<span class="sd">        beta_knob: `beta_knob * min_eta` is the early stopping cost threshold.</span>
<span class="sd">            Set to `np.inf` to disable early stopping.</span>
<span class="sd">        eta_knob: $\eta$ used in the hybrid cost metric.</span>
<span class="sd">            $\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}$</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of [`HistoryEntry`][zeus._legacy.simulate.HistoryEntry] objects for each job run.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy all internal state so that simulation does not modify any</span>
    <span class="c1"># internal state and is deterministic w.r.t. the random seed.</span>
    <span class="n">bso</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bso</span><span class="p">)</span>
    <span class="n">plo</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plo</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Sanity check</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">default_bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must give the job a default batch size.&quot;</span><span class="p">)</span>

    <span class="c1"># Figure out MAXPOWER.</span>
    <span class="n">max_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Max power = </span><span class="si">{</span><span class="n">max_power</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>

    <span class="c1"># Track the minimum cost observed for the early stopping energy threshold.</span>
    <span class="c1"># Also track the corresponding minimum cost BS to handle concurrent jobs.</span>
    <span class="n">min_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_bs</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">default_bs</span>

    <span class="c1"># Simulate each job one at a time.</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HistoryEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> recurring </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> times.&quot;</span><span class="p">)</span>

    <span class="c1"># A new job. Profile the feasible batch size range.</span>
    <span class="n">batch_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_batch_size_range</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="c1"># Register the job in the BSO.</span>
    <span class="n">bso</span><span class="o">.</span><span class="n">register_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">batch_sizes</span><span class="p">)</span>

    <span class="c1"># List of jobs in flight.</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">RunningJob</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents a job that is running.</span>

<span class="sd">        We know what&#39;s going to happen to this job when we launch it.</span>
<span class="sd">        Thus, pre-compute all results (using self.run_job) and have this</span>
<span class="sd">        instance hold the information. Then, jobs will be removed from the</span>
<span class="sd">        list of running jobs when the current time passes self.end_time and</span>
<span class="sd">        the result will be observed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">runtime_ratio</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">power_limit</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">reached</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">time</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">energy</span><span class="p">:</span> <span class="nb">float</span>
        <span class="n">cost</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">running_jobs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RunningJob</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Jobs in group_df are already sorted by start_time.</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">rec_i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">job_row</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Recurrence: </span><span class="si">{</span><span class="n">rec_i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update the current time.</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">job_row</span><span class="o">.</span><span class="n">start_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Current time is </span><span class="si">{</span><span class="n">current_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Scan the in-flight job list to reap jobs that have finished.</span>
        <span class="c1"># We need a while loop here because we might have submitted a retry job</span>
        <span class="c1"># while reaping jobs that failed to reach the target metric, and that retry job</span>
        <span class="c1"># may finish before the current job.</span>
        <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&lt;=</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">running_jobs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Running jobs: </span><span class="si">{</span><span class="n">running_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># We copy running_jobs because we want to mutate it as we traverse it.</span>
            <span class="n">running_jobs_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_jobs</span><span class="p">)</span>

            <span class="c1"># Sort the jobs in the order they end.</span>
            <span class="k">for</span> <span class="n">rjob</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">running_jobs_copy</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">)):</span>
                <span class="c1"># We&#39;re only interested in jobs that finished at this point in time.</span>
                <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">current_time</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Job is finished at this point in time.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[Simulator] Job(BS=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,time=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">,&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;energy=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">energy</span><span class="si">}</span><span class="s2">,reached=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="si">}</span><span class="s2">) finished&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Remove the job from the in-flight job list.</span>
                <span class="n">running_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rjob</span><span class="p">)</span>

                <span class="c1"># Let the BSO observe the cost for this batch size.</span>
                <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">)</span>

                <span class="c1"># If the job never ran because even one epoch exceeds the cost threshold,</span>
                <span class="c1"># do not add to the history and retry.</span>
                <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                    <span class="c1"># Record history for analysis.</span>
                    <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">HistoryEntry</span><span class="p">(</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">power_limit</span><span class="p">,</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the energy of this job by the runtime ratio.</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">,</span>
                            <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the runtime of this job by the runtime ratio.</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Reached target metric (no need to retry)</span>
                <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">min_cost</span> <span class="o">&gt;</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Minimum cost updated from </span><span class="si">{</span><span class="n">min_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span>
                        <span class="n">best_bs</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span>

                <span class="c1"># Didn&#39;t reach target metric. Need to run a retry job.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># If there are jobs in-flight, we just run additional concurrent</span>
                    <span class="c1"># submissions with the best known knobs.</span>
                    <span class="k">if</span> <span class="n">running_jobs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are in-flight jobs. Use BS </span><span class="si">{</span><span class="n">best_bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                        <span class="n">bs</span> <span class="o">=</span> <span class="n">best_bs</span>
                        <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">pl</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Power not profiled for best known BS </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="c1"># There are no jobs in-flight. Just submit the job normally.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Determine the knobs.</span>
                        <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                        <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are no in-flight jobs. Use BSO&#39;s prediction </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                        <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
                        <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                            <span class="k">assert</span> <span class="n">pl</span>

                    <span class="c1"># Pre-compute the result of the job.</span>
                    <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                        <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                        <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                        <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                        <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                        <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># Compute the hybrid cost metric.</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>

                    <span class="c1"># Create the RunningJob instance.</span>
                    <span class="n">running_job</span> <span class="o">=</span> <span class="n">RunningJob</span><span class="p">(</span>
                        <span class="n">start_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                        <span class="n">end_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">rjob</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>  <span class="c1"># Assume same runtime.</span>
                        <span class="n">runtime_ratio</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>
                        <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                        <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                        <span class="n">reached</span><span class="o">=</span><span class="n">reached</span><span class="p">,</span>
                        <span class="n">time</span><span class="o">=</span><span class="n">tta</span><span class="p">,</span>
                        <span class="n">energy</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
                        <span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_job</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Started retry job </span><span class="si">{</span><span class="n">running_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># We must break from the loop that scans the running_jobs list, because</span>
                    <span class="c1"># the job we just submitted might actually be the next job that finishes.</span>
                    <span class="k">break</span>

        <span class="c1"># We&#39;re (finally) done reaping all finished jobs. Run the current job.</span>
        <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># If there are jobs in-flight, we just run additional concurrent</span>
        <span class="c1"># submissions with the best known knobs.</span>
        <span class="k">if</span> <span class="n">running_jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are in-flight jobs. Use BS </span><span class="si">{</span><span class="n">best_bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">best_bs</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">pl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Power not profiled for best known BS </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># There are no jobs in-flight. Just submit the job.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Determine the knobs.</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are no in-flight jobs. Use BSO&#39;s prediction </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
            <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">pl</span>

        <span class="c1"># Run the job, potentially early stopping it.</span>
        <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
            <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
            <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
            <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
            <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
            <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
            <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Compute the hybrid cost metric.</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>

        <span class="c1"># Create the RunningJob instance and enqueue.</span>
        <span class="n">running_job</span> <span class="o">=</span> <span class="n">RunningJob</span><span class="p">(</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">job_row</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">job_row</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
            <span class="n">runtime_ratio</span><span class="o">=</span><span class="n">job_row</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
            <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
            <span class="n">reached</span><span class="o">=</span><span class="n">reached</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">tta</span><span class="p">,</span>
            <span class="n">energy</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
            <span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_job</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Started job </span><span class="si">{</span><span class="n">running_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Now, we&#39;re done iterating the rows of group_df.</span>
    <span class="c1"># Set the current time to infinity so that all running jobs finish.</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Simulator] Reap all jobs&quot;</span><span class="p">)</span>

    <span class="c1"># Scan the remaining in-flight job list to reap jobs that have finished.</span>
    <span class="c1"># Since current_time is infinity, this while loop will reap all the jobs ever launched.</span>
    <span class="k">while</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&lt;=</span> <span class="n">current_time</span><span class="p">,</span> <span class="n">running_jobs</span><span class="p">)):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Running jobs: </span><span class="si">{</span><span class="n">running_jobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># We copy running_jobs because we want to mutate it as we traverse it.</span>
        <span class="n">running_jobs_copy</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">running_jobs</span><span class="p">)</span>

        <span class="c1"># Sort the jobs in the order they end.</span>
        <span class="k">for</span> <span class="n">rjob</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">running_jobs_copy</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;end_time&quot;</span><span class="p">)):</span>
            <span class="c1"># We&#39;re only interested in jobs that finished at this point in time.</span>
            <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="n">current_time</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Job is finished at this point in time.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Simulator] Job(BS=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,time=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;energy=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">energy</span><span class="si">}</span><span class="s2">,reached=</span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="si">}</span><span class="s2">) finished&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Remove the job from the in-flight job list.</span>
            <span class="n">running_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rjob</span><span class="p">)</span>

            <span class="c1"># Let the BSO observe the cost for this batch size.</span>
            <span class="n">bso</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">)</span>

            <span class="c1"># If the job never ran because even one epoch exceeds the cost threshold,</span>
            <span class="c1"># do not add to the history and retry.</span>
            <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                <span class="c1"># Record history for analysis.</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">HistoryEntry</span><span class="p">(</span>
                        <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                        <span class="n">rjob</span><span class="o">.</span><span class="n">power_limit</span><span class="p">,</span>
                        <span class="n">rjob</span><span class="o">.</span><span class="n">energy</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the energy of this job by the runtime ratio.</span>
                        <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">,</span>
                        <span class="n">rjob</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>  <span class="c1"># Scale the runtime of this job by the runtime ratio.</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Reached target metric (no need to retry)</span>
            <span class="k">if</span> <span class="n">rjob</span><span class="o">.</span><span class="n">reached</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">min_cost</span> <span class="o">&gt;</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Minimum cost updated from </span><span class="si">{</span><span class="n">min_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rjob</span><span class="o">.</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">min_cost</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">cost</span>
                    <span class="n">best_bs</span> <span class="o">=</span> <span class="n">rjob</span><span class="o">.</span><span class="n">batch_size</span>

            <span class="c1"># Didin&#39;t reach target metric. Need to run a retry job.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># If there are jobs in-flight, we just run additional concurrent</span>
                <span class="c1"># submissions with the best known knobs.</span>
                <span class="k">if</span> <span class="n">running_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are in-flight jobs. Use BS </span><span class="si">{</span><span class="n">best_bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">bs</span> <span class="o">=</span> <span class="n">best_bs</span>
                    <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">pl</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Power not profiled for best known BS </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># There are no jobs in-flight. Just submit the job normally.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Determine the knobs.</span>
                    <span class="n">bs</span> <span class="o">=</span> <span class="n">bso</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] There are no in-flight jobs. Use BSO&#39;s prediction </span><span class="si">{</span><span class="n">bs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                    <span class="c1"># When the batch size is first explored, we need to profile power limit.</span>
                    <span class="k">if</span> <span class="n">pl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">profiled_power</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">plo</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">epe</span><span class="p">)</span>
                        <span class="n">pl</span> <span class="o">=</span> <span class="n">plo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">bs</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">pl</span>

                <span class="c1"># Pre-compute the result of the job.</span>
                <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">reached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_job</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                    <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                    <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
                    <span class="n">cost_ub</span><span class="o">=</span><span class="n">beta_knob</span> <span class="o">*</span> <span class="n">min_cost</span><span class="p">,</span>
                    <span class="n">eta_knob</span><span class="o">=</span><span class="n">eta_knob</span><span class="p">,</span>
                    <span class="n">profile_power</span><span class="o">=</span><span class="n">profiled_power</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Compute the hybrid cost metric.</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">zeus_cost</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">max_power</span><span class="p">)</span>

                <span class="c1"># Create the RunningJob instance.</span>
                <span class="n">running_job</span> <span class="o">=</span> <span class="n">RunningJob</span><span class="p">(</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                    <span class="n">end_time</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">rjob</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">rjob</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>  <span class="c1"># Assume same runtime.</span>
                    <span class="n">runtime_ratio</span><span class="o">=</span><span class="n">rjob</span><span class="o">.</span><span class="n">runtime_ratio</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span>
                    <span class="n">power_limit</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span>
                    <span class="n">reached</span><span class="o">=</span><span class="n">reached</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">tta</span><span class="p">,</span>
                    <span class="n">energy</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
                    <span class="n">cost</span><span class="o">=</span><span class="n">cost</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">running_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">running_job</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Simulator] Started retry job </span><span class="si">{</span><span class="n">running_job</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># We must break from the loop that scans the running_jobs list, because</span>
                <span class="c1"># the job we just submitted might actually be the next job that finishes.</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">history</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zeus._legacy.simulate.Simulator._run_job" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">_run_job</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">_run_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">power_limit</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">cost_ub</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Simulate running the job and return the energy consumed and whether it converged.</p>
<p>This method will randomly choose one of the possible training "paths". Then,
based on cost_ub, it will compute the maximum number of epochs the job can run.
If the path's target_epoch is smaller than or equal to the maximum number of
epochs, the cost incurred until target_epoch is returned. Otherwise, the cost
incurred until the maximum number of epochs is returned.</p>
<p>It is important to note that the job may never run when the first epoch's cost
is already expected to exceed the cost upper bound. In such a case, the returned
time and energy consumptions will be zero. This case must be treated separately
in the calling code.</p>
<p>If profile_power is True, the first epoch will JIT-profile power limits coarsely
by dividing the epoch evenly into len(available_power_limits) pieces. Thus the
the first epoch's energy and time consumption will be slightly adjusted.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>job</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;span class=&quot;doc doc-object-name doc-class-name&quot;&gt;Job&lt;/span&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;zeus._legacy.job.Job&lt;/code&gt;)" href="../job/#zeus._legacy.job.Job">Job</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Job spec to run.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>power_limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Power limit to use. Regardless of whether this run of this
batch size requires power profiling, the simulator will input the optimal
power limit for the batch size. The first epoch energy consumption from
power profiling is adjusted in the latter half of this method based on the
profile_power flag.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rng</code>
            </td>
            <td>
                  <code><span title="numpy.random.Generator">Generator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random number generator used to sample one training path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cost_ub</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cost upper bound. The job is terminated when the next epoch is going
to exceed the cost upper bound.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eta_knob</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><span class="arithmatex">\(\eta\)</span> used in the hybrid cost metric.
<span class="arithmatex">\(\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}\)</span></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>profile_power</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether this run of the job should profile power during the
first epoch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="float">float</span>, <span title="float">float</span>, <span title="bool">bool</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of energy consumption, time consumption, and whether the job reached the target metric.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_run_job</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">power_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
    <span class="n">cost_ub</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">profile_power</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Simulate running the job and return the energy consumed and whether it converged.</span>

<span class="sd">    This method will randomly choose one of the possible training &quot;paths&quot;. Then,</span>
<span class="sd">    based on cost_ub, it will compute the maximum number of epochs the job can run.</span>
<span class="sd">    If the path&#39;s target_epoch is smaller than or equal to the maximum number of</span>
<span class="sd">    epochs, the cost incurred until target_epoch is returned. Otherwise, the cost</span>
<span class="sd">    incurred until the maximum number of epochs is returned.</span>

<span class="sd">    It is important to note that the job may never run when the first epoch&#39;s cost</span>
<span class="sd">    is already expected to exceed the cost upper bound. In such a case, the returned</span>
<span class="sd">    time and energy consumptions will be zero. This case must be treated separately</span>
<span class="sd">    in the calling code.</span>

<span class="sd">    If profile_power is True, the first epoch will JIT-profile power limits coarsely</span>
<span class="sd">    by dividing the epoch evenly into len(available_power_limits) pieces. Thus the</span>
<span class="sd">    the first epoch&#39;s energy and time consumption will be slightly adjusted.</span>

<span class="sd">    Args:</span>
<span class="sd">        job: Job spec to run.</span>
<span class="sd">        batch_size: Batch size to use.</span>
<span class="sd">        power_limit: Power limit to use. Regardless of whether this run of this</span>
<span class="sd">            batch size requires power profiling, the simulator will input the optimal</span>
<span class="sd">            power limit for the batch size. The first epoch energy consumption from</span>
<span class="sd">            power profiling is adjusted in the latter half of this method based on the</span>
<span class="sd">            profile_power flag.</span>
<span class="sd">        rng: Random number generator used to sample one training path.</span>
<span class="sd">        cost_ub: Cost upper bound. The job is terminated when the next epoch is going</span>
<span class="sd">            to exceed the cost upper bound.</span>
<span class="sd">        eta_knob: $\eta$ used in the hybrid cost metric.</span>
<span class="sd">            $\textrm{cost} = \eta \cdot \textrm{ETA} + (1 - \eta) \cdot \textrm{MaxPower} \cdot \textrm{TTA}$</span>
<span class="sd">        profile_power: Whether this run of the job should profile power during the</span>
<span class="sd">            first epoch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of energy consumption, time consumption, and whether the job reached the target metric.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># df is filtered with job spec, BS, and PL. We sample one possible training path.</span>
    <span class="c1"># power_df is filtered with job spec and BS. We use this to compute the energy</span>
    <span class="c1"># consumption of profiling power during the first epoch.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">filter_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
    <span class="n">power_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">power_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">power_limit</span> <span class="o">==</span> <span class="n">power_limit</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

    <span class="c1"># Max number of epochs is bound by either the cost upper bound or the user-specified</span>
    <span class="c1"># max_epochs, whichever is smaller.</span>
    <span class="k">if</span> <span class="n">cost_ub</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
        <span class="c1"># cost_ub is infinity in two cases:</span>
        <span class="c1"># 1. The simulator has never observed any cost value in the early part of simulation.</span>
        <span class="c1"># 2. We&#39;re simulating with no early stopping, i.e. beta_knob is infinity.</span>
        <span class="n">max_epochs</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">max_epochs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] Cost UB is inf. </span><span class="si">{</span><span class="n">max_epochs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Stop right before the first epoch when cost will cross the upper bound.</span>
        <span class="n">cost_per_epoch</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">eta_knob</span> <span class="o">*</span> <span class="n">path</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta_knob</span><span class="p">)</span> <span class="o">*</span> <span class="n">power_df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">path</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">max_epochs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cost_ub</span> <span class="o">//</span> <span class="n">cost_per_epoch</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">cost_ub</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">cost_per_epoch</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">max_epochs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># The job virtually never ran. Time and Energy being zero will be treated specially outside.</span>
    <span class="c1"># If the min_cost is so low, this might even prevent this BS from running at all.</span>
    <span class="k">if</span> <span class="n">max_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> cannot run even one epoch without exceeding the cost UB.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; BS </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">, PL </span><span class="si">{</span><span class="n">power_limit</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">eta_knob</span><span class="si">=}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_energy_and_time</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the energy and time consumed for running the job for num_epochs.&quot;&quot;&quot;</span>
        <span class="c1"># This is the first run of this batch size, and we need to profile power</span>
        <span class="c1"># during the first epoch.</span>
        <span class="k">if</span> <span class="n">profile_power</span><span class="p">:</span>
            <span class="c1"># Note that power_df holds rows with all power limits. Evenly splitting the</span>
            <span class="c1"># epochs with the number of samples and running each slice with each power</span>
            <span class="c1"># limit consumes (1/N) * e_100 + (1/N) * e_125 + ... + (1/N) * e_250.</span>
            <span class="c1"># Also there are all runs 1, 2, ... included, but power info is actually</span>
            <span class="c1"># completely duplicated across different runs in the DataFrame.</span>
            <span class="c1"># Thus, taking the mean across the entire power_df gets us what we want.</span>
            <span class="n">energy_first_epoch</span> <span class="o">=</span> <span class="n">power_df</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">energy_from_second_epoch</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">energy_consumption</span> <span class="o">=</span> <span class="n">energy_first_epoch</span> <span class="o">+</span> <span class="n">energy_from_second_epoch</span>
            <span class="n">time_first_epoch</span> <span class="o">=</span> <span class="n">power_df</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">time_from_second_epoch</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">time_consumption</span> <span class="o">=</span> <span class="n">time_first_epoch</span> <span class="o">+</span> <span class="n">time_from_second_epoch</span>
        <span class="c1"># Just run num_epochs with the given power limit. Simple.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy_consumption</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">energy_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">num_epochs</span>
            <span class="n">time_consumption</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">time_per_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">num_epochs</span>
        <span class="k">return</span> <span class="n">energy_consumption</span><span class="p">,</span> <span class="n">time_consumption</span>

    <span class="c1"># Job reached target metric.</span>
    <span class="n">target_epoch</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">target_epoch</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">target_epoch</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="ow">and</span> <span class="n">target_epoch</span> <span class="o">&lt;=</span> <span class="n">max_epochs</span><span class="p">:</span>
        <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span> <span class="o">=</span> <span class="n">compute_energy_and_time</span><span class="p">(</span><span class="n">target_epoch</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">power_limit</span><span class="si">}</span><span class="s2">W</span><span class="si">{</span><span class="s1">&#39; prof&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">profile_power</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;=&gt; </span><span class="se">\033</span><span class="s2">[31mReached in </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">target_epoch</span><span class="p">)</span><span class="si">}</span><span class="s2"> epochs, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;TTA </span><span class="si">{</span><span class="n">tta</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds, ETA </span><span class="si">{</span><span class="n">eta</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">eta</span><span class="p">,</span> <span class="n">tta</span><span class="p">,</span> <span class="kc">True</span>

    <span class="c1"># Job failed to reach the target metric.</span>
    <span class="n">energy_consumption</span><span class="p">,</span> <span class="n">time_consumption</span> <span class="o">=</span> <span class="n">compute_energy_and_time</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">,</span> <span class="n">profile_power</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[run job] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">power_limit</span><span class="si">}</span><span class="s2">W</span><span class="si">{</span><span class="s1">&#39; prof&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">profile_power</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;=&gt; </span><span class="se">\033</span><span class="s2">[31mFailed (stopped after </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">)</span><span class="si">}</span><span class="s2"> epochs), &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;TTA </span><span class="si">{</span><span class="n">time_consumption</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds, ETA </span><span class="si">{</span><span class="n">energy_consumption</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">energy_consumption</span><span class="p">,</span> <span class="n">time_consumption</span><span class="p">,</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zeus._legacy.simulate.Simulator._profile_power_limit" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">_profile_power_limit</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">_profile_power_limit</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Simulate running the job and profiling the power limit.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="int">int</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping PL to <code>energy_per_epoch</code>. PL is inserted in high to low order.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_profile_power_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta_knob</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate running the job and profiling the power limit.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping PL to `energy_per_epoch`. PL is inserted in high to low order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filter by job spec and BS.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">filter_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="n">batch_size</span><span class="p">)]</span>

    <span class="c1"># Compute the epoch cost of each power limit (Equation 7).</span>
    <span class="n">max_pl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">power_limit</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;power_limit&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;epoch_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">eta_knob</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;average_power&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta_knob</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_pl</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;time_per_epoch&quot;</span><span class="p">]</span>

    <span class="c1"># We&#39;ll be profiling energy from larger to smaller power limits.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;power_limit&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">rec</span><span class="o">.</span><span class="n">power_limit</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">epoch_cost</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[PL profile] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> =&gt; PL = </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">)</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zeus._legacy.simulate.Simulator._profile_batch_size_range" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">_profile_batch_size_range</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">_profile_batch_size_range</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Simulate profiling the available batch size range of the job.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of feasible batch sizes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zeus/_legacy/simulate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_profile_batch_size_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate profiling the available batch size range of the job.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of feasible batch sizes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
    <span class="c1"># Do not filter by target_metric here since we do not want to constrain</span>
    <span class="c1"># the feasible batch size range to only those that reached the target metric.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">network</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">network</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">batch_size</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[BS profile] </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> =&gt; BS = </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026 Zeus team
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/ml-energy/zeus" target="_blank" rel="noopener" title="Zeus GitHub repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://hub.docker.com/r/mlenergy/zeus" target="_blank" rel="noopener" title="Zeus Docker Hub registry" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://join.slack.com/t/zeus-ml/shared_invite/zt-36fl1m7qa-Ihky6FbfxLtobx40hMj3VA" target="_blank" rel="noopener" title="Zeus Slack workspace" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "search.suggest", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "content.tooltips", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.dd8806f2.min.js"></script>
      
        <script src="../../../assets/js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>